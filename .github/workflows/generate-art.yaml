name: Generate p5go Art

on:
  schedule:
    # 毎週日曜日の午前9時（JST）に実行
    - cron: "0 0 * * 0"
  workflow_dispatch:
    inputs:
      theme:
        description: "Art theme (leave empty for random)"
        required: false
        type: string
      art_name:
        description: "Art name (leave empty for date-based name)"
        required: false
        type: string

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "yarn"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Install dependencies
        run: yarn install

      - name: Generate art code with AI
        id: generate
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ART_THEME: ${{ github.event.inputs.theme }}
          ART_NAME: ${{ github.event.inputs.art_name }}
        run: npx tsx scripts/generate-art.ts

      - name: Build WASM
        run: |
          make go-build ART_NAME=${{ steps.generate.outputs.art_name }}

      - name: Install Puppeteer dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libxkbcommon0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libgbm1 \
            libasound2

      - name: Install ImageMagick
        run: sudo apt-get install -y imagemagick

      - name: Start dev server and generate GIF
        run: |
          # Start dev server in background
          yarn dev &
          DEV_PID=$!

          # Wait for server to be ready
          echo "Waiting for dev server..."
          for i in {1..30}; do
            if curl -s http://localhost:4321 > /dev/null; then
              echo "Dev server is ready!"
              break
            fi
            sleep 2
          done

          # Generate GIF
          ./scripts/art_gif.sh go ${{ steps.generate.outputs.art_name }}

          # Kill dev server
          kill $DEV_PID || true

      - name: Verify generated files
        run: |
          echo "Checking generated files..."
          ls -la art/go/${{ steps.generate.outputs.art_name }}/
          ls -la public/wasm/go_${{ steps.generate.outputs.art_name }}.wasm
          ls -la public/art/go/${{ steps.generate.outputs.art_name }}/art.gif

      - name: Create branch and commit
        id: commit
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          BRANCH_NAME="art/${{ steps.generate.outputs.art_name }}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          # Create new branch
          git checkout -b $BRANCH_NAME

          # Add all generated files
          git add art/go/${{ steps.generate.outputs.art_name }}/
          git add art/data/data.ts
          git add public/wasm/go_${{ steps.generate.outputs.art_name }}.wasm
          git add public/art/go/${{ steps.generate.outputs.art_name }}/

          # Commit
          git commit -m "feat: add generated art '${{ steps.generate.outputs.art_name }}'

          Theme: ${{ steps.generate.outputs.art_theme }}
          Date: ${{ steps.generate.outputs.art_date }}

          Generated by GitHub Actions"

          # Push
          git push -u origin $BRANCH_NAME

      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "feat: Add generated art '${{ steps.generate.outputs.art_name }}'" \
            --body "$(cat <<'EOF'
          ## Generated Art

          **Name:** ${{ steps.generate.outputs.art_name }}
          **Theme:** ${{ steps.generate.outputs.art_theme }}
          **Date:** ${{ steps.generate.outputs.art_date }}

          ### Preview
          ![Art Preview](https://raw.githubusercontent.com/${{ github.repository }}/${{ steps.commit.outputs.branch_name }}/public/art/go/${{ steps.generate.outputs.art_name }}/art.gif)

          ### Generated Files
          - `art/go/${{ steps.generate.outputs.art_name }}/main.go` - Source code
          - `public/wasm/go_${{ steps.generate.outputs.art_name }}.wasm` - Compiled WASM
          - `public/art/go/${{ steps.generate.outputs.art_name }}/art.gif` - Preview GIF

          ---
          Generated by [generate-art workflow](https://github.com/${{ github.repository }}/actions/workflows/generate-art.yaml)
          EOF
          )" \
            --base master \
            --head ${{ steps.commit.outputs.branch_name }}
