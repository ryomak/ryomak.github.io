name: publish content from GitHub Issue

on:
  issues:
    types: [labeled]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check issue labels
        if: contains(github.event.issue.labels.*.name, 'publish') != true
        run: exit 0
      - name: Define date and file name
        id: define_date_and_filename
        run: |
          date=$(date +%Y%m%d)
          issue_id=${{ github.event.issue.number }}
          title=${{ github.event.issue.title }}
          filename="${date}_${issue_id}.md"
          echo "filename=$filename" >> $GITHUB_OUTPUT
          echo "date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
          echo "title=$title" >> $GITHUB_OUTPUT
      - name: Generate Description with OpenAI API
        id: generate_description
        run: |
          description=$(curl -s -X POST "https://api.openai.com/v1/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d '{
              "model": "gpt-4o-mini",
              "prompt": "Summarize the following text in around 30 characters and japanese: ${GITHUB_EVENT_ISSUE_BODY}",
              "max_tokens": 30
            }' | jq -r '.choices[0].text' | tr -d '\n')
          echo "description=$description" >> $GITHUB_OUTPUT
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_EVENT_ISSUE_BODY: "${{ github.event.issue.body }}"
      - name: Create Content File
        run: |
          content="$(echo "${{ github.event.issue.body }}" | sed -r "s/published: [0-9]{4}-[0-9]{2}-[0-9]{2}/published: ${{ steps.define_date_and_filename.outputs.date }}/" | sed -r "s/title: .*/title: '${{ steps.define_date_and_filename.outputs.title }}'/" | sed -r "s/description: .*/description: '${{ steps.generate_description.outputs.description }}'/")"
          echo -e "$content" >> src/content/posts/${{ steps.define_date_and_filename.outputs.filename }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Commit Content File
        uses: EndBug/add-and-commit@v9
        with:
          new_branch: ${{ steps.define_date_and_filename.outputs.filename }}
      - name: Create PullRequest
        run: gh pr create --title "${{ steps.define_date_and_filename.outputs.title }}" --body "#${{ github.event.issue.number}}" --base main --head ${{ steps.define_date_and_filename.outputs.filename }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Close Issue
        run: gh issue close ${{ github.event.issue.number }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
